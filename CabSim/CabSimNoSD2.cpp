// #include <stdio.h>
#include <string.h>
#include "daisysp.h"
#include "daisy_core.h"
#include "daisy_petal.h"
#include "fatfs.h"

using namespace daisysp;
using namespace daisy;

DaisyPetal hw;
SdmmcHandler sd; // Handler for SD Card Hardware
static FIR<FIRFILTER_USER_MEMORY> flt;
// FIR<1024, 48> flt;

Parameter volume;

// static constexpr size_t kMaxFiles   = 8;
// static constexpr size_t kBufferSize = 512;

float flt_buffer[1024];
float coeff_arr2[] = {0.006545046827834448, 0.05572284635039674, 0.1890039278932939, 0.2746010087733517, 0.3363739181233847, 0.35082127955441095, 0.3131616900397308, 0.22447439529385316, 0.10564302107690265, -0.0021153939880520535, -0.07661981019878294, -0.12383000711327655, -0.14967493252770878, -0.14540681130958621, -0.10569355835604435, -0.042515323897571, 0.02329225661322307, 0.07335244775369054, 0.09921614032748574, 0.10184112971781148, 0.08351439536975264, 0.04748278990424068, -0.0010695940325507643, -0.049715344587172965, -0.08551504158341398, -0.10303927879199856, -0.10430297887281771, -0.09087058563548214, -0.0660286978634313, -0.03992445052194437, -0.024975871884788593, -0.02830322221427334, -0.04030797082864041, -0.04433975988992792, -0.035412222180964924, -0.020158476127453487, -0.008087238148486192, -0.0006114072418177761, 0.0006136861111689934, -0.0048897163464516795, -0.014138239506090557, -0.024100182823798763, -0.034655436479653315, -0.0477648334992384, -0.059949277664505876, -0.07017027480699217, -0.07908313391631057, -0.08620312607634331, -0.08749685361214321, -0.0838768696477345, -0.07920800255164344, -0.0772966343960945, -0.07636571626612222, -0.07325405421817327, -0.06781063964494494, -0.0598167681142895, -0.04712829166898808, -0.027663865310118576, -0.003104088158634603, 0.023080790942543932, 0.043176866265115556, 0.04919918067912225, 0.038002961505453244, 0.013665173039005503, -0.016901301568872405, -0.0465060933105366, -0.06835696505911472, -0.07771742091923986, -0.07384374517558533, -0.0609480926960306, -0.04452749850912674, -0.0283791621841242, -0.013702573306593128, -0.001755935860682098, 0.005466337317878815, 0.00644310093715205, 0.0012099455743580898, -0.01060150129857043, -0.02808431670541817, -0.04615843168333765, -0.05952064914976956, -0.06596911213245388, -0.06668259931609237, -0.06394051625645555, -0.05965644295287445, -0.05649129450074105, -0.055671772866701816, -0.056340419944576635, -0.056356506081173464, -0.054595275200528245, -0.05104493080246997, -0.04599160504171471, -0.040516286297569336, -0.035298881943526435, -0.03118478548331849, -0.02891087602421852, -0.02923601706018191, -0.032541785156399244, -0.037598194093335556, -0.043491886440136775, -0.049329478385556555, -0.054268525550905174, -0.05729312138452378, -0.05718628262729318, -0.054036885183910845, -0.048500036967282605, -0.042211564018167565, -0.03708363879894452, -0.03469109408244295, -0.035556997410336376, -0.03863735851749066, -0.04258864987022488, -0.046216207723947925, -0.04888965660077161, -0.05049465087972014, -0.05075705598295589, -0.050313748868574974, -0.04981279976472208, -0.04977037257944795, -0.050081974450442344, -0.0501298307068179, -0.04915112334603922, -0.04610125887284976, -0.04152455193434469, -0.03736259921776118, -0.035070056650436554, -0.03468412342325099, -0.035799428893964404, -0.03785671171356042, -0.03966760854094835, -0.040228009324640344, -0.039268940455623624, -0.03703042049703668, -0.03380548523721841, -0.029911433720541232, -0.025833329990968688, -0.021916757883055957, -0.018164599496276638, -0.014483019033815906, -0.011160896698725128, -0.009038934204896038, -0.009367962723870325, -0.012086653859872589, -0.016016698107185163, -0.019747006158420455, -0.021538532596323035, -0.020561903028188108, -0.01708153332432603, -0.012704294479621635, -0.009189473633214687, -0.007886630620009915, -0.009407976988654936, -0.013153365792949755, -0.01818598065283659, -0.023215244234265756, -0.026975043535928563, -0.02832051481111493, -0.026776245697819428, -0.023108338451466, -0.018940487484796983, -0.016158189083668097, -0.015606434598396892, -0.01680920843685556, -0.018525063007183897, -0.01939693161073198, -0.019100745620642883, -0.0181007241288734, -0.01659606712694759, -0.01353655097180003, -0.008401588067815876, -0.0025830984096048316, 0.002446567325239253, 0.005503469483189826, 0.006411934047495696, 0.006264142667512337, 0.006275201886422656, 0.006161526521138405, 0.004881070048030884, 0.002970573224880929, 0.0017298629142814058, 0.0023277980166993384, 0.005131678651095636, 0.008800055076433139, 0.011398904494789032, 0.012316953715483844, 0.012021437981086281, 0.01041791826465913, 0.007360479902155328, 0.003924347073934531, 0.0009021641608054447, -0.001625906256524404, -0.003515088948683562, -0.004370938441203972, -0.004219326603778867, -0.003934266858169242, -0.0037118089941489394, -0.003695521780844651, -0.0037978027993728165, -0.004162287844429281, -0.004661695360191641, -0.004789915273982192, -0.004296003854890414, -0.0032333134559624555, -0.0019838898213729835, -0.0008131542049696623, 0.0001289571950512389, 0.0006994118141162568, 0.0004957881350280738, -0.0004199822163155213, -0.00175131109641051, -0.0029056254483712358, -0.003802695665921018, -0.0045401109777472816, -0.005176317680151834, -0.005793958299900881, -0.00633606110321399, -0.006399802419478921, -0.0055014587161152225, -0.0037536329493006925, -0.0015410518859761357, 0.0008531014441851189, 0.0029651441537795, 0.004342050420898835, 0.004990589828027622, 0.0050566100136437715, 0.004960495347477723, 0.004918269238911049, 0.005042132490706626, 0.005045550794733452, 0.004701910701683711, 0.004041708845522223, 0.0032606598881770635, 0.00267552666946744, 0.002340197746992727, 0.002352128298302041, 0.0028725818427785847, 0.0038496805898975872, 0.005178529523933898, 0.006587943192092657, 0.007737699805350948, 0.008449377298622286, 0.008920365973063582, 0.009733788280309859, 0.011288111228978378, 0.013502636033808385, 0.015696516963339128, 0.01714172228542583, 0.017456943537154507, 0.016603171837277855, 0.014831686044552157, 0.012524062724168008, 0.010448079770778182, 0.009436261778837692, 0.009887678987086182, 0.011753000576626711, 0.014523033298600517, 0.017582951607162996, 0.020401980020187973, 0.022429101333664932, 0.02329172040866984, 0.022849552728964526, 0.021378877690599516, 0.0195516936499073, 0.017853734906542938, 0.016528237250964296, 0.015629424368616526, 0.015327608230718538, 0.01581602355313973, 0.017010687297730833, 0.018598791133252694, 0.020146545576144172, 0.021290269888178653, 0.021913607681305743, 0.02196380983260168, 0.021416412009325446, 0.020337903576077274, 0.019060128125735893, 0.01812089882518859, 0.017849914449101188, 0.018201396533741886, 0.018994107940119746, 0.0200120252588532, 0.02081271270796032, 0.021227533955451024, 0.02117150057963874, 0.020514650001934923, 0.019676294182963565, 0.019158320584545696, 0.019011400536961334, 0.018968169044857357, 0.018793031232659393, 0.018640011858282065, 0.018570640394208242, 0.018649998668085928, 0.01873740001026203, 0.018689744830593925, 0.018667626392773286, 0.01880757578116569, 0.01881300485226712, 0.01849248858057532, 0.0184270045995124, 0.018952552087244605, 0.01958534048562233, 0.019845198617230258, 0.019883738319493492, 0.01960142662221916, 0.01854315991085533, 0.016576562686323935, 0.014005595904735877, 0.011372161292696805, 0.009450136071652456, 0.00864737082990158, 0.008486710540640758, 0.00886553905749606, 0.010102227833946377, 0.012023314697022577, 0.013793459978365208, 0.015046435968119812, 0.016069045076694006, 0.016636014366163045, 0.016352362157505643, 0.01563183728910605, 0.015274993158933079, 0.015327407154011078, 0.015447248871657446, 0.015700136344073416, 0.016368314242964165, 0.017316793072054644, 0.01803524014781048, 0.01852338736795506, 0.019212075091006767, 0.020356201556456167, 0.021662596924826073, 0.02262642460925269, 0.023003510461310002, 0.022927570491459145, 0.02279888139868452, 0.022730046139163924, 0.022566637801567813, 0.02197064644065533, 0.02082712320532831, 0.01938312434348637, 0.018106622378958905, 0.017486836940996946, 0.017573098848497438, 0.01817063179750045, 0.018814211312511882, 0.019447669966581142, 0.02002777626760426, 0.020467665077958355, 0.02049903304432217, 0.02016068797123555, 0.019682058381910762, 0.01918285194285586, 0.018630896380877195, 0.018212924931636277, 0.018220029641966545, 0.01863431468490402, 0.019169513854594325, 0.019634604278950116, 0.020162899815017614, 0.020831882020738206, 0.021562661801218276, 0.022217367560709182, 0.02262642460925269, 0.022646733356706188, 0.022307919104635494, 0.02188284294506431, 0.021594498946566166, 0.02142056759461296, 0.021208029514827368, 0.02105943382801417, 0.021119153610129893, 0.021396572440856028, 0.02170864349083449, 0.0218039538501707, 0.02162579988736083, 0.021361987247172847, 0.021092812561452588, 0.020836707861717253, 0.020664049995577964, 0.02061049656582436, 0.020504261038716137, 0.020203517309924608, 0.01985237035312968, 0.019598611548314715, 0.019388754491295263, 0.01906977980769399, 0.01863431468490402, 0.018189063829017648, 0.01789790475661506, 0.01784837286101066, 0.017889861688316647, 0.01771458982498037, 0.017307677594649774, 0.01692335298112389, 0.01679942270375916, 0.016901904798994786, 0.01706189483256407, 0.017111426728168472, 0.016962160785663736, 0.016564498083876313, 0.015937071731030865, 0.015270971624783872, 0.014720155497480814, 0.014290655650345504, 0.0139992284756663, 0.013814036828095316, 0.013613563350757345, 0.013374215043310374, 0.013221865924624581, 0.013262952598515646, 0.0134193902769198, 0.013666245448111958, 0.013997954989852384, 0.014338914060135988, 0.014441731283217381, 0.01412215336949373, 0.013384671032098313, 0.012607107404349132, 0.012502413465331442, 0.013125617207320226, 0.013735750963324087, 0.013942189716316713, 0.014081468849017583, 0.014158615279113206, 0.013726702511488371, 0.0128522199107433, 0.012167620747409957, 0.01197284444345003, 0.012204350759306048, 0.01283492731390171, 0.013769866978023192, 0.014676320775254457, 0.015309109173632185, 0.015741491120241095, 0.01598848034257156, 0.015987072805619337, 0.015791760297106182, 0.01565402275249584, 0.015685792872274576, 0.015786532302712212, 0.015860662582195928, 0.015872392056797784, 0.01573190646385215, 0.015458308090567766, 0.015203812004492114, 0.015019960868304198, 0.014973378097742551, 0.015148918063355438, 0.015513403108411903, 0.01586629273000482, 0.016160266876311852, 0.016397805493391683, 0.016438490013867827, 0.01611763861433026, 0.015510856136784072, 0.0148597027324583, 0.014321621463294397, 0.014048425243424933, 0.014150438159676485, 0.014555808801916554, 0.015020497072857427, 0.015311186966275942, 0.015359378350497273, 0.015236118328824077, 0.014964798824890909, 0.01454562091540523, 0.014082608283693192, 0.013728780304132127, 0.013471335093013724, 0.013322404278354757, 0.013368048690948256, 0.013576632262153795, 0.013807267245610818, 0.013962565489339362, 0.014051173291760224, 0.01407067773238388, 0.01401243251278953, 0.013956667239253859, 0.013948222017540524, 0.01385720129463014, 0.013615708168970257, 0.013337887184829204, 0.013166033625519756, 0.013003027441338565, 0.01274089044037942, 0.01243478466605561, 0.012162928957569215, 0.011847171501287309, 0.011391732758889613, 0.01084895969988497, 0.010310945456290223, 0.009799942517064316, 0.009334651016001061, 0.008980085755179308, 0.008727734487316566, 0.008455543650984403, 0.008075575699453491, 0.00766470896054284, 0.007365104666426916, 0.00723795716174282, 0.007153504944609473, 0.00695396982523965, 0.006632783297856315, 0.006287400540008584, 0.005920904727877516, 0.005523040949382634, 0.0051580867253420955, 0.004823830211973838, 0.004445806001948376, 0.00408963212746694, 0.0039539723755003565, 0.0041323274150176885, 0.004496343281090078, 0.004841659013368656, 0.005043070848674775, 0.005134627776138388, 0.005251855496587773, 0.005410773121050604, 0.005510976346935013, 0.0054881206278536866, 0.0054714312611344774, 0.0055040727133122075, 0.005483965042566172, 0.005320087525985986, 0.005056274885798004, 0.004752380955256259, 0.004413164549770646, 0.0040237459929890985, 0.0036325847714095607, 0.0033801664779776657, 0.0033315059147722608, 0.0033959845122978802, 0.0033948450776222715, 0.0033835177564353384, 0.003457245882504134, 0.00368540091990248, 0.004031185831165131, 0.004396743285328051, 0.004679859289432226, 0.004832945689378707, 0.004877249590589138, 0.004768534117422241, 0.004501973428898968, 0.00421141758661876, 0.004087487309254029, 0.004151362676657268, 0.004249354058759613, 0.004166845583131715, 0.003800282745431494, 0.003183647509219749, 0.0024636588453733825, 0.0018828822886587334, 0.0015822726110055077, 0.001391785943471401, 0.001208471011836714, 0.0012202004864385677, 0.0014595487938855397, 0.001699567357024046, 0.0018708176862111123, 0.0020885837603906734, 0.002289526416712718, 0.002286108112685892, 0.0021080882010143273, 0.001975511625228802, 0.0020023218528901826, 0.002126051053547452, 0.0022078892734838152, 0.002213050242308631, 0.00222759479081493, 0.0022766575074352558, 0.002163518346704231, 0.0017738987132152229, 0.0011284424822674939, 0.00037313134347725935, -0.0002211843782063869, -0.00022466970780236632, 0.00044538490702467905, 0.0014369611770808268, 0.0023928798443473387, 0.0030596502062858653, 0.003314883573622205, 0.0031375339176421746, 0.0026948300333836336, 0.0021202868546002555, 0.0014394411231395045, 0.0006661001062469918, -1.8029878102278203e-05, -0.0002264793981695095, 0.00015489609031362427, 0.0008815873110753354, 0.001587232503122863, 0.00210192184865221, 0.0022773947886959435, 0.001965658866563245, 0.001183805602388244, 0.0001870013379381271, -0.0007270933741766318, -0.0014490928050976013, -0.001939786996870013, -0.0020796693596932645, -0.0017958160743284013, -0.001278579757171223, -0.0007240772235647266, -0.00017781883496410436, 0.0003085857203824864, 0.0006720653819016489, 0.0010143649635683209, 0.0012683918706598986, 0.0011529068150085034, 0.0006554430407515932, 0.00013351493375367355, -0.0002092538268970727, -0.0005197162632158557, -0.0009012258028372964, -0.0012630298251276226, -0.0014919891693558097, -0.0015697388295738124, -0.0016574752995956793, -0.0019438085310192201, -0.0023836303158041626, -0.0027265331275932157, -0.0029188965110636188, -0.0030077724157610945, -0.002854082785692232, -0.002273306228977583, -0.001274223095176249, -0.00021716284405717985, 0.0004506129014186482, 0.0007082591892445122, 0.000830647878518713, 0.0009524333376705326, 0.00103862821960187, 0.0010050484094559914, 0.0008253528585555903, 0.0004492723900355792, -8.311170575027871e-06, -0.0003453827578477308, -0.0005061100726777053, -0.0006487404838362481, -0.0007150287717290107, -0.0005979351024179326, -0.000501753410682731, -0.0006222653840206352, -0.00091275420073169, -0.0012153746454595191, -0.0015409178348378286, -0.001914049178315088, -0.002320760331938226, -0.0027085032494909376, -0.0029706402504500826, -0.0030882701243143884, -0.003173124494862657, -0.003317564596388343, -0.003441964052737147, -0.003585934975278759, -0.003855511814413937, -0.004183400898712618, -0.0042409088370462785, -0.0038069182767776857, -0.0029378647471340453, -0.001836098441389625, -0.0007839310568187579, 3.183714534788902e-05, 0.0006057100684397328, 0.000985946122247258, 0.0009940562161148254, 0.0006188470799938092, 0.00022064817365315928, 0.0001813041645600838, 0.0005429741357121031, 0.0011293138146664886, 0.0017124362663015087, 0.0020970960076731617, 0.0022775288398342503, 0.002358227625095005, 0.0023743807872609866, 0.0022148599326757743, 0.0018168621030425847, 0.0014230198586969091, 0.0012821991379055094, 0.001294330765922284, 0.0011848780114946992, 0.0008709302455799367, 0.00039451250003721006, -0.000372930266769799, -0.0015757041052284694, -0.0029809621880997144, -0.004080583675631224, -0.004659081362994656, -0.004818803294287329, -0.004731334926542076, -0.004468259567614782, -0.0039031669940820407, -0.0029416181790066385, -0.0017875049037533732, -0.0008303127506729457, -0.000431845742055682, -0.0007289700901129284, -0.0014273765206918834, -0.0020905945274652766, -0.0026122545321865826, -0.0031387403778869367, -0.003702559465605763, -0.004124351372288428, -0.004229715566997652, -0.004061012209438416, -0.0038585279650258427, -0.0037062458719092028, -0.0035347944660146765, -0.0033764130461050724, -0.0032683678286297103, -0.0031937013445927664, -0.003124195829380638, -0.0032019454895986406, -0.0035130111560398047, -0.0038978049485497647, -0.004152837239178644, -0.004396006004067363, -0.0048604931983007756, -0.005441604882861191, -0.00585803474401158, -0.006027743485108117, -0.006110251960736015, -0.006041885880199495, -0.005667548076477473, -0.0050883131078533535, -0.004697084860704663, -0.004613101822555389, -0.004606399265640044, -0.004568797921344958, -0.0046276463710616875, -0.004763239097459119, -0.004774633444215205, -0.004557001421173951, -0.004221404396422624, -0.004009536572328567, -0.003953570222085435, -0.004007324728546503, -0.004203374518320346, -0.0046399120502167695, -0.005161706106076382, -0.0054017246692148885, -0.005208624004483797, -0.004750504239319963, -0.004236217047205537, -0.0037493433128748714, -0.003323797974319614, -0.002951336886533889, -0.002659909711854686, -0.002577937440780016, -0.002821910512498576, -0.0033746033557379295, -0.003941103466222893, -0.004238629967695061, -0.004117581789803929, -0.0036227320127440034, -0.002960586415077065, -0.0024423447143825856, -0.0021539336903152874, -0.0018809385471532834, -0.0016915242887256322, -0.0017257743545630454, -0.0019459533492321305, -0.0022089616825902705, -0.002632697330778385, -0.0031953769838216025, -0.0036725320106250174, -0.00390859606518347, -0.0039223363068599275, -0.0038469325415622954, -0.0037162997072822204, -0.0034934396898469973, -0.003195846162805677, -0.0030018071401064373, -0.003041620328183587, -0.003236463657712668, -0.0034272184275233883, -0.003608857719929239, -0.0037929099328246146, -0.0039726054837250155, -0.0041950633477453175, -0.004558610034833634, -0.004982747836436669, -0.005214790356845915, -0.005245421041949042, -0.005317272452081541, -0.0056948274831229275, -0.006281971468907155, -0.0068280958063694705, -0.007080514099801365, -0.007049347210145011, -0.006963353404921133, -0.007019990010855799, -0.007101023923962321, -0.006878230932096251, -0.006342897711267641, -0.00571895668801817, -0.005241466533368988, -0.005001179867953868, -0.0050690097439371595, -0.0053496458019826575, -0.005651797067726412, -0.005873182522640259, -0.006032904453932932, -0.006181500140746132, -0.0063355919242299155, -0.0064697771136751235, -0.006565489626426251, -0.006570851671958527, -0.006465688553956763, -0.006287065412162817, -0.0060778786108348975, -0.005885046048380421, -0.005737522770673676, -0.005610576342697041, -0.005418347010364945, -0.0051818137768224175, -0.00508844715899166, -0.005231613774703431, -0.005538456830287928, -0.005910046585674658, -0.006247051147378207, -0.006483249253074967, -0.0065412263703927016, -0.006403890979197281, -0.006186661109570948, -0.006056296377567487, -0.006066752366355425, -0.006204355859827459, -0.006521923006476508, -0.006998273726450081, -0.0074388998180648655, -0.007495268321722917, -0.007038086914527231, -0.0063038218044511795, -0.005584235294019735, -0.004920280005985653, -0.004334141403738728, -0.003984603060603483, -0.003949816790212842, -0.004082795519413288, -0.004116375329559167, -0.004044724996134128, -0.003953637247654589, -0.003850752999004042, -0.003670588269119567, -0.0034164273108896826, -0.0032211818279456812, -0.003201878464029487, -0.003386600932616397, -0.003561805770383517, -0.0035996752169552165, -0.003568374276160555, -0.0035626100772133584, -0.00354478127581854, -0.0034400873368008508, -0.0033049637893874943, -0.003154826514483765, -0.003049194217497927, -0.0030509368822959166, -0.003177280080150171, -0.0033725255630941723, -0.00361314735635506, -0.003840498086923564, -0.003908998218598391, -0.0038527637660786458, -0.0038441174676578506, -0.003910204678843153, -0.0038448547489185387, -0.003532850724509226, -0.0031016752381450787, -0.0027995239724013235, -0.0028495920725589512, -0.003299668769424372, -0.0039293069660518865, -0.0043300528440203675, -0.004343256881143597, -0.004170062810451081, -0.004047338993331113, -0.00394666658846263, -0.0037872797850157245, -0.003614755970014743, -0.0035107322866885877, -0.0035071129059543013, -0.0035585215174949976, -0.003594514248130401, -0.003591297020811035, -0.003483452880043133, -0.0031624674293672583, -0.002863868518788636, -0.00304343001855073, -0.003668041297491736, -0.004135343565629593, -0.004068921226598524, -0.0037625473499981014, -0.003721125548261269, -0.004082393365998367, -0.004504252298250185, -0.004545003844295483, -0.004110007900489589, -0.003581176159868864, -0.0034659592064940825, -0.003872536308978914, -0.00441537639355271, -0.004649697783313173, -0.0045348829833533125, -0.004383271145928207, -0.0043857510919868845, -0.004450698868496578, -0.004454184198092558, -0.004436221345559433, -0.004377037767996936, -0.004258871689579403, -0.004234206280130933, -0.004370603313358205, -0.004511222957442144, -0.004422414078313822, -0.004114967792606944, -0.0037652283727642394, -0.0035438429178503922, -0.003469578587228369, -0.003496925019442977, -0.0035940450691463264, -0.0036881489682377712, -0.003725750312532857, -0.0037766897450894794, -0.0038740108715002897, -0.0038648953940954205, -0.003632316669132947, -0.003130094079466142, -0.002629279026751559, -0.0023534017841159564, -0.002291604209356475, -0.0022245786402030243, -0.002066800450415802, -0.00190768174924551, -0.0017747700456142176, -0.0015738273892921728, -0.0013533132667773206, -0.0012526408619088377, -0.001322280428259273, -0.001433274770777387, -0.0014818012828444853, -0.0014959436779358633, -0.0015238933402728521, -0.0015298586159275093, -0.0014632352001889793, -0.0013202026356155159, -0.0011451988745558564, -0.0010104104549882673, -0.0008826597201817906, -0.0006967307913501187, -0.0004906271662032582, -0.00038760886641440464, -0.0003512810079332345, -0.0002469892223304654, -4.6515744992494694e-05, 0.00014772435441420505, 0.000507852737475695, 0.0008799116718464992, 0.0011959372304050186, 0.0013695334545124555, 0.0014383016884638958, 0.001495139371106022, 0.0015622989913977794, 0.0016309331742109128, 0.0017219538971212987, 0.001843538279565658, 0.0019665301989622397, 0.002072966802777919, 0.00217048900589619, 0.0022443511831032924, 0.002295156564521608, 0.00232860232352918, 0.002356753062573629, 0.002382155753282787, 0.002399046196709456, 0.0024042741911034253, 0.002400185631385065, 0.0023891934380438993, 0.002372101917909769, 0.002349916454519977, 0.0023235083802735177, 0.0022931457974470046, 0.002258761680471284, 0.0022244445890647175, 0.0021817493015139694, 0.002136708119042851, 0.0020894550927896684, 0.00203898483921712, 0.0019871740742615027, 0.002082417408028556, 0.00237444781283014, 0.0022613756776682687, 0.0019619724602598053, 0.0017712847160182383, 0.0016625692428513415, 0.0015924604975168322};
float coeff_arr[1024];

float samplerate;
bool bypass;
char TEST_FILE_NAME[] = "07_Ampeg_SVT-810E_by_Shift_Line.wav";


struct WavInfo
{
    WAV_FormatTypeDef raw_data;               /*< Raw wav data*/
    char              name[WAV_FILENAME_MAX]; /**< Wav filename */
};

void AudioCallback(float *in, float *out, size_t size) {
    // float output;
    hw.ProcessDigitalControls();
    volume.Process();
 
    if(hw.switches[DaisyPetal::SW_1].RisingEdge())
        bypass = !bypass;

    // output = s162f(sampler.Stream()) * 0.5f;
    for(size_t i = 0; i < size; i += 2) {
        // out[i] = out[i + 1] = in[i];
        if (bypass) {
            out[i] = out[i + 1] = volume.Value() * in[i];
        } else {
            out[i] = out[i + 1] = volume.Value() * flt.Process(in[i]);
        }
    }
}

//TODO: fix the interpolation from mismatching sample rates
void LoadIRFromWavFile(const WavInfo *file_info) {
    size_t bits_per_sample = file_info->raw_data.BitPerSample;
    // size_t num_channels = file_info->raw_data.NbrChannels;
    size_t data_size = file_info->raw_data.SubCHunk2Size;
    size_t num_samples = data_size / bits_per_sample;
    int byte_chunk_size = bits_per_sample / 8;
    int wav_sample_rate = file_info->raw_data.SampleRate;

 
    // if (wav_sample_rate - samplerate < 1.0f) {
    //     match = true;
    // }
    // if (num_samples == 1000)
    //     match = true;
    // if (wav_sample_rate == 48000) {
    //     hw.SetAudioSampleRate(SaiHandle::Config::SampleRate::SAI_48KHZ);
    // }

    // unsigned char data[byte_chunk_size];
    // float new_floatt;
    // int new_int;
    // float tmp_int = 0;
    // unsigned char *data = (unsigned char *) &tmp_int;
    // char data[4] = {0};
    // float tmp_int = (* (float*) data);
    // float tmp = 0.;

    // int temp;
    // unsigned char *ptr = (unsigned char *)&temp;
    int temp;
    unsigned char bytes[3];
    size_t bytesread;
    float sum = 0;
    for (int i = 0; i < (int)num_samples; i++) {
        temp = 0;
        // switch (bits_per_sample) {
        //     case 8:
        //         f_read(&SDFile, &data, byte_chunk_size, &bytesread);
        //         tmp = tmp_int / 128.0f;
        //         break;
        //     case 16:
        //         f_read(&SDFile, &data, byte_chunk_size, &bytesread);
        //         tmp = tmp_int / 32768.0f;
        //         break;
        //     case 24:
        //         f_read(&SDFile, &data[1], byte_chunk_size, &bytesread);
        //         tmp = tmp_int / 2147483648.0f;
        //         break;
        //     case 32:
        //         f_read(&SDFile, &data, byte_chunk_size, &bytesread);
        //         tmp = tmp_int;
        //         break;
        // }d
        // https://stackoverflow.com/questions/35876000/converting-24-bit-integer-2s-complement-to-32-bit-integer-in-c

        // https://github.com/erwincoumans/DaisyCloudSeed/blob/0.43/patch/SamplePlayer/b3ReadWavFile.cpp
        // f_read(&SDFile, ptr + 1, byte_chunk_size, &bytesread);
        f_read(&SDFile, bytes, byte_chunk_size, &bytesread);
        // temp &= 0xffffff00;
        temp = bytes[2] << 16 | bytes[1] << 8 | bytes[0];
        if (temp & 0x800000) //  if the 24th bit is set, this is a negative number in 24-bit world
            temp = temp | ~0xFFFFFF; // so make sure sign is extended to the 32 bit float
        coeff_arr[i] = (float) temp / 8388608.0f;
        sum += coeff_arr[i] * coeff_arr[i];
        // coeff_arr[i] = s242f(temp);
    }

    float autoGain = DSY_MIN(1.0f, 1.0f / fastroot(sum, 2));
    for (int j = 0; j < (int)num_samples; j++) {
        coeff_arr[j] = autoGain * coeff_arr[j];
    }

    flt.SetStateBuffer(flt_buffer, num_samples + 1);
    flt.SetIR(coeff_arr2, num_samples, false);
    flt.Reset();
    // match = true;
}

void LoadIR() {
    WavInfo file_info;
    strcpy(file_info.name, TEST_FILE_NAME);
    // file_info.name = "07_Ampeg_SVT-810E_by_Shift_Line.wav";
    size_t bytesread;
    if(f_open(&SDFile, file_info.name, (FA_OPEN_EXISTING | FA_READ)) == FR_OK) {
    // if(f_open(&SDFile, TEST_FILE_NAME, (FA_OPEN_EXISTING | FA_READ)) == FR_OK) {
        // Get WAV Info of TEST_FILE
        if(f_read(&SDFile, (void *)&file_info.raw_data,
                  sizeof(WAV_FormatTypeDef), &bytesread) == FR_OK) {

            // Load WAV to filter.
            LoadIRFromWavFile(&file_info);

        }
        f_close(&SDFile);
    }
}


int main(void) {
    // initialize petal hardware
    // Init daisy.
    hw.Init();
    samplerate = hw.AudioSampleRate();

    // Init SDMMC and load wav.
    coeff_arr[0] = 1;
    flt.SetStateBuffer(flt_buffer, 2);
    flt.Init(coeff_arr2, 1, false);

    SdmmcHandler::Config sd_cfg;
    sd_cfg.Defaults();
    sd.Init(sd_cfg);
    dsy_fatfs_init();
    f_mount(&SDFatFS, SDPath, 1);
    LoadIR();

    // Initialize knobs.
    volume.Init(hw.knob[hw.KNOB_3], 0.0f, 1.0f, Parameter::LINEAR);

    // Initialize fx.

    // Start pedal fx.
    hw.StartAdc();
    hw.StartAudio(AudioCallback);

    // Pedal fx update loop.
    while(1) {
        // sampler.Prepare();
        System::Delay(10);
        hw.ClearLeds();
        hw.SetFootswitchLed(hw.FOOTSWITCH_LED_1, bypass ? 0.0f : 1.0f);
        hw.UpdateLeds();
    }
}